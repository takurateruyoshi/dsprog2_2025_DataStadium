<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .selection-section h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* æŠ•æ‰‹é¸æŠ */
        .hand-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hand-button {
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }

        .hand-button:hover, .hand-button.selected {
            background: #667eea;
            color: white;
        }

        /* çƒç¨®é¸æŠ */
        .pitch-selector {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .pitch-button {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: bold;
            color: #667eea;
            text-align: left;
        }

        .pitch-button:hover, .pitch-button.selected {
            background: #667eea;
            color: white;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— */
        .heatmap-container h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .zone-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 3px;
            background: #333;
            padding: 3px;
            border-radius: 12px;
            aspect-ratio: 1;
            max-width: 100%;
        }

        .zone-cell {
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 80px;
        }

        .zone-cell:hover, .zone-cell.selected {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 3px solid #667eea;
        }

        .zone-cell .rate {
            font-size: 20px;
            font-weight: bold;
        }

        .zone-cell .label {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 25px;
            height: 15px;
            border-radius: 3px;
        }

        /* çƒé€Ÿåˆ¥ã‚°ãƒ©ãƒ• */
        .chart-container {
            margin-top: 30px;
        }

        .chart-header {
            margin-bottom: 15px;
        }

        .chart-header h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .chart-header .zone-info {
            color: #667eea;
            font-size: 14px;
            font-weight: bold;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            border-left: 2px solid #333;
            border-bottom: 2px solid #333;
            padding: 20px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 80px;
        }

        .bar {
            width: 100%;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
            position: relative;
            min-height: 5px;
        }

        .bar:hover {
            opacity: 0.8;
            transform: scaleY(1.02);
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        .bar-label {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        /* è¦‹é€ƒã—ãƒ»ç©ºæŒ¯ã‚Šãƒ»ãƒ•ã‚¡ã‚¦ãƒ«ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆå††ã‚°ãƒ©ãƒ• */
        .pie-chart-container {
            margin-top: 30px;
        }

        .pie-chart-header {
            margin-bottom: 15px;
        }

        .pie-chart-header h3 {
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }

        .pie-chart-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pie-chart {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pie-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .pie-legend-label {
            font-size: 14px;
            color: #333;
        }

        .pie-legend-value {
            font-weight: bold;
            color: #667eea;
            margin-left: auto;
        }

        .current-selection {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
            font-size: 13px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .current-selection strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¾ ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³åˆ†æãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="current-selection" id="currentSelection">
            æŠ•æ‰‹: <strong id="selectedPitcherDisplay">æœªé¸æŠ</strong> | 
            æ‰“è€…: <strong id="selectedBatterDisplay">æœªé¸æŠ</strong> | 
            çƒç¨®: <strong id="selectedPitchDisplay">æœªé¸æŠ</strong> | 
            ã‚³ãƒ¼ã‚¹: <strong id="selectedZoneDisplay">æœªé¸æŠ</strong>
        </div>

        <div class="main-layout">
            <div class="left-panel">
                <div>
                    <h3>æŠ•æ‰‹</h3>
                    <div class="hand-selector" id="pitcherHandSelector"></div>
                </div>

                <div>
                    <h3>æ‰“è€…</h3>
                    <div class="hand-selector" id="batterHandSelector"></div>
                </div>

                <div>
                    <h3>çƒç¨®</h3>
                    <div class="pitch-selector" id="pitchSelector"></div>
                </div>
            </div>

            <div class="right-panel">
                <div>
                    <h3>ã‚³ãƒ¼ã‚¹åˆ¥è¢«æ‰“ç‡</h3>
                    <div class="zone-grid" id="zoneGrid"></div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff4444;"></div>
                            <span>é«˜(0.400~)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffaa44;"></div>
                            <span>ä¸­(0.250~)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #44ff44;"></div>
                            <span>ä½(~0.249)</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>çƒé€Ÿåˆ¥æ‰“æ•°åˆ†å¸ƒ</h3>
                        <div class="zone-info" id="zoneInfo">æŠ•æ‰“ã®çµ„ã¿åˆã‚ã›ã¨çƒç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>
                    <div class="bar-chart" id="barChart">
                        <p style="text-align: center; color: #999; margin: auto;">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã™ã‚‹ã¨çƒé€Ÿåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>

                <div class="pie-chart-container">
                    <div class="pie-chart-header">
                        <h3>è¦‹é€ƒã—ãƒ»ç©ºæŒ¯ã‚Šãƒ»ãƒ•ã‚¡ã‚¦ãƒ«ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆæ¯”ç‡</h3>
                    </div>
                    <div class="pie-chart-content" id="pieChartContent">
                        <p style="text-align: center; color: #999; margin: auto;">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã™ã‚‹ã¨è¦‹é€ƒã—ãƒ»ç©ºæŒ¯ã‚Šãƒ»ãƒ•ã‚¡ã‚¦ãƒ«ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ
                            æ¯”ç‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒªã‚¢
        // ============================================
        const analysisData = {
            // JSONã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§null
            data: null, 
            
            // å…¨ã¦ã®çƒç¨®ãƒªã‚¹ãƒˆï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã«åˆã‚ã›ã¦å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            pitchTypes: [
                'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ', 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', 'ãƒ•ã‚©ãƒ¼ã‚¯', 'ã‚«ãƒƒãƒˆãƒœãƒ¼ãƒ«', 'ã‚·ãƒ¥ãƒ¼ãƒˆ', 'ãƒã‚§ãƒ³ã‚¸ã‚¢ãƒƒãƒ—', 'ã‚«ãƒ¼ãƒ–', 'ã‚·ãƒ³ã‚«ãƒ¼', 'ç‰¹æ®Šçƒ'
            ]
        };

        // ============================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        // ============================================
        let selectedPitcherHand = null;
        let selectedBatterHand = null;
        let selectedPitch = null;
        let selectedZone = null;
        let selectedZoneName = '';

        // ============================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ============================================
        // é¸æŠã•ã‚Œã¦ã„ã‚‹æŠ•æ‰“ã®çµ„ã¿åˆã‚ã›ã‚­ãƒ¼ã‚’ç”Ÿæˆ (ä¾‹: "å³æŠ•ã’_å³æ‰“ã¡" -> "å³_å³")
        function getCurrentDataKey() {
            if (selectedPitcherHand && selectedBatterHand) {
                // ã‚­ãƒ¼ã¯Pythonã§ç”Ÿæˆã•ã‚ŒãŸJSONã®ã‚­ãƒ¼ (ä¾‹: "å³_å·¦") ã«åˆã‚ã›ã‚‹
                const pitcherKey = selectedPitcherHand.includes('å³') ? 'å³' : 'å·¦';
                const batterKey = selectedBatterHand.includes('å³') ? 'å³' : 'å·¦';
                return `${pitcherKey}_${batterKey}`;
            }
            return null;
        }

        // ç¾åœ¨ã®é¸æŠã«åŸºã¥ã„ã¦ã€é¸æŠã•ã‚ŒãŸçƒç¨®ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function getCurrentPitchData() {
            const dataKey = getCurrentDataKey();
            if (analysisData.data && dataKey && selectedPitch) {
                const combinedData = analysisData.data[dataKey];
                
                // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: çµ„ã¿åˆã‚ã›ã®å­˜åœ¨ç¢ºèª
                if (!combinedData) {
                    console.warn(`[DEBUG] çµ„ã¿åˆã‚ã›ã‚­ãƒ¼ '${dataKey}' ã®ãƒ‡ãƒ¼ã‚¿ãŒJSONã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
                }
                
                const pitchData = combinedData ? combinedData[selectedPitch] : null;

                // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: çƒç¨®ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
                if (!pitchData) {
                    console.warn(`[DEBUG] çµ„ã¿åˆã‚ã› '${dataKey}' ã«å¯¾ã™ã‚‹çƒç¨® '${selectedPitch}' ã®ãƒ‡ãƒ¼ã‚¿ãŒJSONã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
                }
                
                return pitchData;
            }
            return null;
        }

        // ============================================
        // åˆæœŸåŒ–ã¨UIæ“ä½œãƒ­ã‚¸ãƒƒã‚¯
        // ============================================

        // åˆæœŸåŒ–
        function init() {
            renderPitcherSelector();
            renderBatterSelector();
            renderPitchSelector();
            renderHeatmap(); 
        }

        // æŠ•æ‰‹é¸æŠUI
        function renderPitcherSelector() {
            const container = document.getElementById('pitcherHandSelector');
            container.innerHTML = '';
            
            const hands = ['å³æŠ•ã’', 'å·¦æŠ•ã’'];
            hands.forEach(hand => {
                const button = document.createElement('button');
                button.className = 'hand-button';
                button.textContent = hand;
                button.onclick = () => selectPitcherHand(hand, button);
                container.appendChild(button);
            });
        }

        // æ‰“è€…é¸æŠUI
        function renderBatterSelector() {
            const container = document.getElementById('batterHandSelector');
            container.innerHTML = '';
            
            const hands = ['å³æ‰“ã¡', 'å·¦æ‰“ã¡'];
            hands.forEach(hand => {
                const button = document.createElement('button');
                button.className = 'hand-button';
                button.textContent = hand;
                button.onclick = () => selectBatterHand(hand, button);
                container.appendChild(button);
            });
        }

        // æŠ•æ‰‹é¸æŠå‡¦ç†
        function selectPitcherHand(hand, buttonElement) {
            selectedPitcherHand = hand;
            document.getElementById('selectedPitcherDisplay').textContent = hand;
            
            document.querySelectorAll('#pitcherHandSelector .hand-button').forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            renderHeatmap();
            clearBarChart();
        }

        // æ‰“è€…é¸æŠå‡¦ç†
        function selectBatterHand(hand, buttonElement) {
            selectedBatterHand = hand;
            document.getElementById('selectedBatterDisplay').textContent = hand;
            
            document.querySelectorAll('#batterHandSelector .hand-button').forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            renderHeatmap();
            clearBarChart();
        }

        // çƒç¨®é¸æŠUI
        function renderPitchSelector() {
            const container = document.getElementById('pitchSelector');
            container.innerHTML = '';
            
            // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çƒç¨®ã‚’å–å¾—ã§ãã‚‹å ´åˆã¯ã€analysisData.pitchTypesã‚’ä¸Šæ›¸ãã—ã¦ã‚‚è‰¯ã„
            // ç¾çŠ¶ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
            analysisData.pitchTypes.forEach(pitch => {
                const button = document.createElement('button');
                button.className = 'pitch-button';
                button.textContent = pitch;
                button.onclick = () => selectPitch(pitch, button);
                container.appendChild(button);
            });
        }

        // çƒç¨®é¸æŠå‡¦ç†
        function selectPitch(pitch, buttonElement) {
            selectedPitch = pitch;
            document.getElementById('selectedPitchDisplay').textContent = pitch;
            
            document.querySelectorAll('.pitch-button').forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            selectedZone = null;
            selectedZoneName = '';
            document.getElementById('selectedZoneDisplay').textContent = 'æœªé¸æŠ';
            
            renderHeatmap();
            clearBarChart();
        }

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”» (ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ )
        function renderHeatmap() {
            const container = document.getElementById('zoneGrid');
            container.innerHTML = '';
            
            const currentData = getCurrentPitchData(); // å†…éƒ¨ã§ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒå®Ÿè¡Œã•ã‚Œã‚‹
            const dataKey = getCurrentDataKey();

            if (!dataKey) {
                container.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">æŠ•æ‰‹ã¨æ‰“è€…ã‚’ä¸¡æ–¹é¸æŠã—ã¦ãã ã•ã„</p>';
                document.getElementById('zoneInfo').textContent = 'æŠ•æ‰“ã®çµ„ã¿åˆã‚ã›ã‚’é¸æŠã—ã¦ãã ã•ã„';
                clearBarChart();
                return;
            }
            
            if (!selectedPitch) {
                container.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">çƒç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                document.getElementById('zoneInfo').textContent = 'çƒç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„';
                clearBarChart();
                return;
            }
            
            if (!currentData || !currentData.battingAverage) {
                // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: ãƒ‡ãƒ¼ã‚¿æ¬ æã®æœ€çµ‚ç¢ºèª
                console.error(`[DEBUG] ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼: ${dataKey}, çƒç¨®: ${selectedPitch}`);
                
                container.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">é¸æŠã•ã‚ŒãŸçµ„ã¿åˆã‚ã›ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                document.getElementById('zoneInfo').textContent = 'é¸æŠã•ã‚ŒãŸçµ„ã¿åˆã‚ã›ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
                clearBarChart();
                return;
            }
            
            const data = currentData;
            
            // 0ã‹ã‚‰24ã®ã‚¾ãƒ¼ãƒ³ãƒ©ãƒ™ãƒ«ï¼ˆPythonå´ã¨åˆã‚ã›ã‚‹ï¼‰
            const zoneLabels = ['é«˜å¤–', 'é«˜ä¸­å¤–', 'é«˜ä¸­', 'é«˜ä¸­å†…', 'é«˜å†…',
                              'å¤–', 'ä¸­å¤–', 'çœŸã‚“ä¸­', 'ä¸­å†…', 'å†…',
                              'ä½å¤–', 'ä½ä¸­å¤–', 'ä½ä¸­', 'ä½ä¸­å†…', 'ä½å†…',
                              'ä½å¤–ä½', 'ä½ä¸­å¤–ä½', 'ä½ä¸­ä½', 'ä½ä¸­å†…ä½', 'ä½å†…ä½',
                              'å¤–ä½', 'ä¸­å¤–ä½', 'ä¸­ä½', 'ä¸­å†…ä½', 'å†…ä½']; 
            
            let index = 0;
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'zone-cell';
                    
                    const avg = data.battingAverage[row][col];
                    const color = getColorForAverage(avg);
                    cell.style.background = color;
                    
                    const rate = document.createElement('div');
                    rate.className = 'rate';
                    rate.textContent = avg.toFixed(3);
                    rate.style.color = avg > 0.3 ? 'white' : '#333';
                    
                    const label = document.createElement('div');
                    label.className = 'label';
                    label.textContent = zoneLabels[index];
                    label.style.color = avg > 0.3 ? 'rgba(255,255,255,0.8)' : '#666';
                    
                    cell.appendChild(rate);
                    cell.appendChild(label);
                    
                    const currentIndex = index;
                    const currentLabel = zoneLabels[index];
                    cell.onclick = () => selectZone(currentIndex, currentLabel, cell);
                    
                    if (currentIndex === selectedZone) {
                         cell.classList.add('selected');
                    }
                    
                    container.appendChild(cell);
                    index++;
                }
            }
        }

        function getColorForAverage(avg) {
            if (avg >= 0.400) return '#ff4444';
            if (avg >= 0.350) return '#ff6644';
            if (avg >= 0.300) return '#ff8844';
            if (avg >= 0.250) return '#ffaa44';
            if (avg >= 0.200) return '#88ff44';
            return '#44ff44';
        }

        function selectZone(zoneIndex, zoneName, cellElement) {
            const dataKey = getCurrentDataKey();
            if (!dataKey || !selectedPitch || !getCurrentPitchData()) {
                alert('å…ˆã«æŠ•æ‰“ã®çµ„ã¿åˆã‚ã›ã¨çƒç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            selectedZone = zoneIndex;
            selectedZoneName = zoneName;
            document.getElementById('selectedZoneDisplay').textContent = zoneName;
            document.getElementById('zoneInfo').textContent = `${selectedPitcherHand} vs ${selectedBatterHand} | ${selectedPitch} - ${zoneName}ã‚³ãƒ¼ã‚¹`;
            
            document.querySelectorAll('.zone-cell').forEach(cell => cell.classList.remove('selected'));
            cellElement.classList.add('selected');
            
            renderBarChart();
            renderPieChart();
        }

        // çƒé€Ÿåˆ¥ã‚°ãƒ©ãƒ•æç”»
        function renderBarChart() {
            const container = document.getElementById('barChart');
            container.innerHTML = '';
            
            const pitchData = getCurrentPitchData();

            if (!pitchData || !pitchData.velocityData || selectedZone === null) {
                clearBarChart();
                return;
            }
            
            const velocityData = pitchData.velocityData[selectedZone];
            if (!velocityData || !velocityData.hits || velocityData.hits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; margin: auto;">æ‰“æ•°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const maxHits = Math.max(...velocityData.hits);
            
            velocityData.speeds.forEach((speed, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bar-wrapper';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                const height = maxHits > 0 ? (velocityData.hits[index] / maxHits) * 200 : 5;
                bar.style.height = height + 'px';
                
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = velocityData.hits[index] + 'å›';
                bar.appendChild(value);
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = speed + '\nkm/h';
                label.style.whiteSpace = 'pre';
                
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });
        }

        function clearBarChart() {
            const container = document.getElementById('barChart');
            container.innerHTML = '<p style="text-align: center; color: #999; margin: auto;">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã™ã‚‹ã¨çƒé€Ÿåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
            document.getElementById('zoneInfo').textContent = (selectedPitcherHand && selectedBatterHand && selectedPitch) 
                                                               ? `${selectedPitcherHand} vs ${selectedBatterHand} | ${selectedPitch} - ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„`
                                                               : 'æŠ•æ‰“ã®çµ„ã¿åˆã‚ã›ã¨çƒç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„';
            clearPieChart();
        }

        // å††ã‚°ãƒ©ãƒ•æç”»
        function renderPieChart() {
            const container = document.getElementById('pieChartContent');
            container.innerHTML = '';
            
            const pitchData = getCurrentPitchData();

            if (!pitchData || !pitchData.velocityData || selectedZone === null) {
                 clearPieChart();
                return;
            }
            
            const zoneData = pitchData.velocityData[selectedZone];
            if (!zoneData) {
                clearPieChart();
                return;
            }
            
            const calledPercent = zoneData.called;
            const swingingPercent = zoneData.swinging;
            const foulPercent = zoneData.foul;
            const contactPercent = zoneData.contact;
            
            // SVGå††ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '200');
            svg.setAttribute('height', '200');
            svg.setAttribute('viewBox', '0 0 200 200');
            svg.classList.add('pie-chart');
            
            // å††ã‚°ãƒ©ãƒ•ã®æç”»
            const centerX = 100;
            const centerY = 100;
            const radius = 80;
            let currentAngle = 0;
            
            // è¦‹é€ƒã—ã®æ‰‡å½¢ (#4CAF50)
            const calledAngle = (calledPercent / 100) * 360;
            const calledPath = createPieSlice(centerX, centerY, radius, currentAngle, currentAngle + calledAngle);
            calledPath.setAttribute('fill', '#4CAF50');
            calledPath.setAttribute('stroke', 'white');
            calledPath.setAttribute('stroke-width', '2');
            svg.appendChild(calledPath);
            currentAngle += calledAngle;
            
            // ãƒ•ã‚¡ã‚¦ãƒ«ã®æ‰‡å½¢ (#2196F3)
            const foulAngle = (foulPercent / 100) * 360;
            const foulPath = createPieSlice(centerX, centerY, radius, currentAngle, currentAngle + foulAngle);
            foulPath.setAttribute('fill', '#2196F3');
            foulPath.setAttribute('stroke', 'white');
            foulPath.setAttribute('stroke-width', '2');
            svg.appendChild(foulPath);
            currentAngle += foulAngle;

            //ã‚³ãƒ³ã‚¿ã‚¯ãƒˆã®æ‰‡å½¢ (#9C27B0)
            const contactAngle = (contactPercent / 100) * 360;
            const contactPath = createPieSlice(centerX, centerY, radius, currentAngle, currentAngle + contactAngle);
            contactPath.setAttribute('fill', '#9C27B0');
            contactPath.setAttribute('stroke', 'white');
            contactPath.setAttribute('stroke-width', '2');
            svg.appendChild(contactPath);
            currentAngle += contactAngle;
            
            // ç©ºæŒ¯ã‚Šã®æ‰‡å½¢ (#FF9800)
            // åˆè¨ˆãŒ360åº¦ã«ãªã‚‹ã‚ˆã†ã«ã€æ®‹ã‚Šã®è§’åº¦ã‚’ä½¿ç”¨
            const swingingAngle = 360 - currentAngle; 
            const swingingPath = createPieSlice(centerX, centerY, radius, currentAngle, currentAngle + swingingAngle);
            swingingPath.setAttribute('fill', '#FF9800');
            swingingPath.setAttribute('stroke', 'white');
            swingingPath.setAttribute('stroke-width', '2');
            svg.appendChild(swingingPath);
            
            // ä¸­å¿ƒã®ç™½ã„å††ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„å‹ã«ã™ã‚‹ï¼‰
            const innerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            innerCircle.setAttribute('cx', centerX);
            innerCircle.setAttribute('cy', centerY);
            innerCircle.setAttribute('r', radius * 0.5);
            innerCircle.setAttribute('fill', 'white');
            svg.appendChild(innerCircle);
            
            // å‡¡ä¾‹ã‚’ä½œæˆ
            const legend = document.createElement('div');
            legend.className = 'pie-legend';
            
            // 1. è¦‹é€ƒã— (called)
            const calledItem = document.createElement('div');
            calledItem.className = 'pie-legend-item';
            calledItem.innerHTML = `
                <div class="pie-legend-color" style="background: #4CAF50;"></div>
                <span class="pie-legend-label">è¦‹é€ƒã—</span>
                <span class="pie-legend-value">${calledPercent}%</span>  `;
            legend.appendChild(calledItem);
            
            // 2. ãƒ•ã‚¡ã‚¦ãƒ« (foul)
            const foulItem = document.createElement('div');
            foulItem.className = 'pie-legend-item';
            foulItem.innerHTML = `
                <div class="pie-legend-color" style="background: #2196F3;"></div>
                <span class="pie-legend-label">ãƒ•ã‚¡ã‚¦ãƒ«</span>
                <span class="pie-legend-value">${foulPercent}%</span>
            `;
            legend.appendChild(foulItem);
            
            // 3. ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ (contact)
            const contactItem = document.createElement('div');
            contactItem.className = 'pie-legend-item';
            contactItem.innerHTML = `
                <div class="pie-legend-color" style="background: #9C27B0;"></div>
                <span class="pie-legend-label">ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ</span>
                <span class="pie-legend-value">${contactPercent}%</span>
            `;
            legend.appendChild(contactItem);

            // 4. ç©ºæŒ¯ã‚Š (swinging)
            const swingingItem = document.createElement('div');
            swingingItem.className = 'pie-legend-item';
            swingingItem.innerHTML = `
                <div class="pie-legend-color" style="background: #FF9800;"></div>
                <span class="pie-legend-label">ç©ºæŒ¯ã‚Š</span>
                <span class="pie-legend-value">${swingingPercent}%</span>
            `;
            legend.appendChild(swingingItem);
            
            container.appendChild(svg);
            container.appendChild(legend);
        }

        // å††ã‚°ãƒ©ãƒ•ã®æ‰‡å½¢ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function createPieSlice(cx, cy, r, startAngle, endAngle) {
            // SVGã®åº§æ¨™ç³»ã«åˆã‚ã›ã¦è§’åº¦ã‚’èª¿æ•´
            const start = polarToCartesian(cx, cy, r, startAngle);
            const end = polarToCartesian(cx, cy, r, endAngle);
            
            // 180åº¦ã‚’è¶…ãˆã¦ã„ã‚Œã° largeArcFlag ã¯ 1
            const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
            
            const d = [
                'M', cx, cy, // ä¸­å¿ƒã‹ã‚‰é–‹å§‹
                'L', start.x, start.y, // é–‹å§‹ç‚¹ã¸ç·š
                'A', r, r, 0, largeArcFlag, 1, end.x, end.y, // å¼§ã‚’æã (ãƒ•ãƒ©ã‚°ã‚’1ã«ä¿®æ­£)
                'Z' // ä¸­å¿ƒã«æˆ»ã£ã¦é–‰ã˜ã‚‹
            ].join(' ');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', d);
            return path;
        }

        function polarToCartesian(cx, cy, r, angleInDegrees) {
            // è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ã—ã€90åº¦ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ0åº¦ãŒä¸Šã«ãªã‚‹ã‚ˆã†ã«ï¼‰
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: cx + (r * Math.cos(angleInRadians)),
                y: cy + (r * Math.sin(angleInRadians))
            };
        }

        function clearPieChart() {
            const container = document.getElementById('pieChartContent');
            container.innerHTML = '<p style="text-align: center; color: #999; margin: auto;">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã™ã‚‹ã¨è¦‹é€ƒã—ãƒ»ç©ºæŒ¯ã‚Šãƒ»ãƒ•ã‚¡ã‚¦ãƒ«ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆæ¯”ç‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
        }

        // ============================================
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–ã®å®Ÿè¡Œ (ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ )
        // ============================================
        async function fetchDataAndInit() {
            try {
                // ğŸ¯ JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã“ã“ã§æŒ‡å®šã—ã¾ã™ã€‚
                const jsonPath = 'analysis_data.json';
                console.log(`[DEBUG] JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹: ${jsonPath}`); 
                
                const response = await fetch(jsonPath); 
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} (ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«åã®èª¤ã‚Šã‚’ç¢ºèªã—ã¦ãã ã•ã„)`);
                }
                
                const jsonData = await response.json();
                analysisData.data = jsonData;

                console.log('[DEBUG] JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚'); 
                console.log('[DEBUG] èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚­ãƒ¼:', Object.keys(jsonData));
                
                // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
                init();
                
            } catch (error) {
                console.error('ğŸš¨ [DEBUG] ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error); 
                const container = document.getElementById('zoneGrid');
                container.innerHTML = '<p style="text-align: center; color: red; grid-column: 1/-1;">åˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚analysis_data.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                init(); 
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–ã‚’é–‹å§‹
        fetchDataAndInit();
    </script>
</body>
</html>